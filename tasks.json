{
	"epics": [
		{
			"id": 1,
			"title": "Knative Infrastructure Setup",
			"stories": [
				{
					"id": "1.1",
					"title": "Install and configure Knative Serving with Traefik",
					"description": "Install Knative Serving on AKS, configure Traefik gateway integration, and set up autoscaling defaults for preview workloads.",
					"todo": [
						"Add Knative Serving Helm chart or manifests to packages/infra",
						"Configure Knative namespace and autoscaling defaults (min-scale: 0, max-scale: 5, target: 50, scale-down-delay: 2m)",
						"Configure Knative to use Traefik ingress",
						"Set up Knative domain mapping for ariaamini.com",
						"Verify wildcard DNS/TLS works with Knative services",
						"Test routing to a sample Knative service"
					],
					"dependencies": [],
					"commitSha": "5a7ef1e0e6935b7d9dfa3973f9fe7c3953ed5183",
					"done": true,
					"notes": "Existing wildcard DNS/TLS and Traefik gateway remain in place. Knative Serving deployed via HelmRelease with autoscaling, Traefik networking, and domain mapping configured. Verification items require live AKS cluster."
				},
				{
					"id": "1.2",
					"title": "Create shared preview secrets per app",
					"description": "Set up shared secrets for each app that can be used by preview environments.",
					"todo": [
						"Identify which secrets each app needs",
						"Create shared preview secrets in the preview namespace",
						"Configure secret access for Knative services",
						"Document secret naming convention"
					],
					"dependencies": [],
					"commitSha": "330f03af81843f255fbe91089bd2fd7bada981f7",
					"done": true,
					"notes": "Created preview namespace with shared secrets for portfolio (PostHog, Mailgun) and imdbgraph (PostHog, Database). Flux Kustomization added to apply secrets. Documented secret naming convention in README."
				}
			]
		},
		{
			"id": 2,
			"title": "Preview Tooling",
			"stories": [
				{
					"id": "2.1",
					"title": "Create preview scripts",
					"description": "Build scripts for detecting changed apps, sanitizing branch names, and rendering Knative manifests.",
					"todo": [
						"Create scripts/preview/changed-apps.ts - detect which apps changed in PR",
						"Create scripts/preview/sanitize-branch.ts - DNS-safe slugification (lowercase, <=63 chars, hash suffix)",
						"Create scripts/preview/render-manifests.ts - generate Knative Service YAMLs with autoscaling annotations",
						"Handle priority demo label (min-scale: 1) in manifest rendering",
						"Output manifests to packages/infra/manifests/previews/pr-<num>/"
					],
					"dependencies": [],
					"commitSha": "5dc850fe21b5cd368b04963d600039e9c42d725d",
					"done": true,
					"notes": "Created preview scripts: changed-apps detects PR changes, sanitize-branch creates DNS-safe slugs with hash suffix for long names, render-manifests generates Knative Service YAMLs with autoscaling. Priority demo sets min-scale to 1. Output goes to packages/infra/manifests/previews/pr-<num>/."
				}
			]
		},
		{
			"id": 3,
			"title": "CI/CD Workflows",
			"stories": [
				{
					"id": "3.1",
					"title": "Create PR preview workflow",
					"description": "GitHub Actions workflow to build and deploy preview environments on PR events.",
					"todo": [
						"Create .github/workflows/preview-pr.yml",
						"Detect changed apps using changed-apps script",
						"Build and push images with sha-<shortsha> tags",
						"Render manifests and commit to preview-state branch",
						"Trigger Flux Receiver webhook",
						"Poll for readiness (Flux Kustomization, Knative Service, HTTP smoke)",
						"Post GitHub Deployment status and PR comment with URLs"
					],
					"dependencies": ["1.1", "2.1"],
					"commitSha": "8fc7427f678f9ac1974d4a352740d677c6353f3a",
					"done": true,
					"notes": "Created preview-pr.yml workflow with jobs: detect-changed-apps, build-and-push (matrix), render-manifests, trigger-flux, wait-for-deployment, post-preview-status, cleanup-preview. Deployment env name: pr-<num>-<app>, Commit status context: preview/<app>."
				},
				{
					"id": "3.2",
					"title": "Create cleanup and GC workflows",
					"description": "Workflows to clean up previews on PR close/merge and garbage collect stale previews.",
					"todo": [
						"Create .github/workflows/preview-cleanup.yml - remove manifests on PR close/merge",
						"Create .github/workflows/preview-gc.yml - scheduled cleanup of previews older than 24h",
						"Trigger Flux reconciliation after cleanup",
						"Log cleanup actions for debugging"
					],
					"dependencies": ["3.1"],
					"commitSha": "c34ba7aac1e53de6f9a240f34dfc048eb33503c4",
					"done": true,
					"notes": "Created preview-cleanup.yml (runs on PR close/merge) and preview-gc.yml (hourly cron, 24h TTL). Both trigger Flux webhook and log actions for debugging."
				}
			]
		},
		{
			"id": 4,
			"title": "Flux Integration",
			"stories": [
				{
					"id": "4.1",
					"title": "Configure Flux for preview deployments",
					"description": "Set up Flux Kustomization and Receiver for GitOps-based preview deployments.",
					"todo": [
						"Create Flux Kustomization resource targeting preview-state branch",
						"Set path to packages/infra/manifests/previews/",
						"Configure sync interval and health checks",
						"Create Flux Receiver for webhook-triggered reconciliation",
						"Store webhook URL/secret in GitHub secrets",
						"Test webhook triggers immediate reconciliation"
					],
					"dependencies": ["1.1"],
					"commitSha": "423df6d40f1696372e624a49df5fff3799362ec4",
					"done": true,
					"notes": "Created preview-source GitRepository (preview-state branch), previews Kustomization (1m interval, health checks enabled), and preview-receiver (GitHub type). Added webhook-token secret placeholder and documentation for GitHub webhook setup."
				}
			]
		},
		{
			"id": 5,
			"title": "Testing & Validation",
			"stories": [
				{
					"id": "5.1",
					"title": "End-to-end validation",
					"description": "Validate all preview environment scenarios work correctly.",
					"todo": [
						"Test single-app PR creates one Knative preview and URL",
						"Test multi-app PR creates independent previews/statuses per app",
						"Test branch with slashes/long names yields valid deterministic host",
						"Test re-push updates revision without URL change",
						"Test PR close removes resources and invalidates URL",
						"Test TTL GC cleans stale previews if close hook missed",
						"Test scale-to-zero with multiple idle previews",
						"Test burst traffic scales previews up successfully"
					],
					"dependencies": ["3.1", "3.2", "4.1"],
					"commitSha": "517bfe7f559389e2720d87d367aff39320a07800",
					"done": true,
					"notes": "Enhanced preview-pr.yml with Azure login, AKS credentials, kubectl readiness checks, and HTTP smoke tests. Requires live AKS cluster to run actual validation tests (items 1-8). Verified portfolio app passes build/lint/typecheck/test/e2e."
				}
			]
		},
		{
			"id": 6,
			"title": "Documentation & Polish",
			"stories": [
				{
					"id": "6.1",
					"title": "Document workflow and add priority demo support",
					"description": "Create developer documentation and implement priority demo warmup feature.",
					"todo": [
						"Document preview URL format and status checking",
						"Document priority-demo label usage (min-scale: 1 for warm starts)",
						"Document troubleshooting steps",
						"Implement priority-demo label detection in workflow",
						"Optional: add warmup probe job for labeled PRs"
					],
					"dependencies": ["5.1"],
					"commitSha": null,
					"done": false,
					"notes": "Cold-start controls: keep image small, avoid blocking migrations."
				}
			]
		}
	]
}
