#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(git -C "$SCRIPT_DIR" rev-parse --show-toplevel 2>/dev/null || (cd "$SCRIPT_DIR/../.." && pwd))"

print_help() {
	cat <<'EOF'
aamini - Monorepo helper CLI

Usage:
  aamini <command> [args...]

Commands:
  e2e <app-name> [playwright-args...]   Run Dockerized e2e tests for an app
  seal                                  Seal app .env.local files into SealedSecrets
  build-all                             Build Docker images for all configured apps
  ralph [iterations]                    Run the autonomous Ralph loop
  pm <subcommand> [args...]             Manage tasks.json workflow

Examples:
  aamini e2e imdbgraph
  aamini e2e imdbgraph --update-snapshots
  aamini seal
  aamini pm next
EOF
}

if [ $# -eq 0 ]; then
	print_help
	exit 0
fi

CMD="$1"
shift

case "$CMD" in
	e2e)
		exec "$SCRIPT_DIR/e2e.sh" "$@"
		;;
	seal)
		exec "$SCRIPT_DIR/seal.sh" "$@"
		;;
	build-all)
		exec "$SCRIPT_DIR/build-all.sh" "$@"
		;;
	ralph)
		exec "$SCRIPT_DIR/ralph.sh" "$@"
		;;
	pm)
		exec pnpm --dir "$REPO_ROOT" exec tsx "$SCRIPT_DIR/../src/pm.ts" "$@"
		;;
	help | --help | -h)
		print_help
		;;
	*)
		echo "Error: Unknown command '$CMD'" >&2
		print_help >&2
		exit 1
		;;
esac
