---
import { Graph } from '#/components/graph'
import { HomeButton } from '#/components/home-button'
import { SearchBar } from '#/components/search-bar'
import { db } from '#/db/connection'
import { getRatings } from '#/lib/imdb/ratings'
import { formatYears, type Ratings } from '#/lib/imdb/types'
import Layout from '#/pages/_Layout.astro'

export const prerender = false

const showId = Astro.params.id

if (!showId) {
	return Astro.redirect('/404')
}
const ratings = await getRatings(db, showId)
if (!ratings) {
	return Astro.redirect('/404')
}
const show = ratings.show

function hasRatings(ratings: Ratings): boolean {
	for (const seasonRatings of Object.values(ratings.allEpisodeRatings)) {
		for (const episode of Object.values(seasonRatings)) {
			if (episode.numVotes > 0) {
				return true
			}
		}
	}
	return false
}
---

<Layout>
	{/* TOP SEARCHBAR */}
	<div class="grid grid-cols-[1fr_minmax(auto,600px)_1fr]">
		<div class="col-start-2 w-full">
			<div class="flex w-full items-center gap-2 pr-4">
				<HomeButton
					className="m-2 cursor-pointer transition-opacity hover:opacity-60 dark:fill-neutral-200"
				/>
				<SearchBar client:load />
			</div>
		</div>
	</div>

	<div class="flex flex-1 flex-col">
		<div class="p-3">
			<h1 class="text-center text-xl">
				{show.title} ({formatYears(show)})
			</h1>
			<h2 class="text-center text-sm">
				Show rating: {show.rating.toFixed(1)} (Votes:{' '}
				{show.numVotes.toLocaleString()})
			</h2>
		</div>
		<div class="min-h-[250px] flex-1 p-5">
			{
				!hasRatings(ratings) ? (
					<h1 class="pt-8 text-center text-6xl leading-tight">
						No Ratings Found
					</h1>
				) : (
					<Graph client:only="react" ratings={ratings}>
						<div
							slot="fallback"
							class="flex flex-1 items-center justify-center"
						>
							<h1 class="animate-pulse rounded-md text-xl">LOADING...</h1>
						</div>
					</Graph>
				)
			}
		</div>
	</div>
</Layout>
