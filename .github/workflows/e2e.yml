name: Test App E2E

on:
  workflow_call:
    inputs:
      app:
        required: true
        type: string
      update_snapshots:
        required: false
        type: boolean
        default: false
      skip:
        required: false
        type: boolean
        default: false

env:
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}

jobs:
  e2e:
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.54.2-noble
      options: --user 1001
    steps:
      # Setup
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Node
        uses: ./.github/actions/setup

      # Check skip status
      - name: Determine if should skip
        id: skip-check
        run: |
          if pnpm dlx turbo-ignore ${{ inputs.app }}; then
            echo "No changes detected in ${{ inputs.app }}. Skipping workflow."
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "Changes detected in ${{ inputs.app }}. Continuing workflow."
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      # Deploy
      - name: Deploy to Vercel
        working-directory: ./apps/${{ inputs.app }}
        run: |
          pnpm i -g vercel
          pnpm vercel link \
            --yes \
            --repo \
            --token=${{ secrets.VERCEL_TOKEN }} \
            --scope=${{ vars.TURBO_TEAM }}
          BASE_URL=$(pnpm vercel \
            --yes \
            ${{ github.ref_name == 'main' && '--prod' || '' }} \
            --token=${{ secrets.VERCEL_TOKEN }} \
            --scope=${{ vars.TURBO_TEAM }} \
            -m githubDeployment='1' \
            -m githubCommitRef='${{ github.head_ref || github.ref_name }}' \
            -m githubCommitSha='${{ github.sha }}' \
          | tail -1)
          echo BASE_URL=$BASE_URL >> $GITHUB_ENV

      # Test
      - name: Run Playwright tests
        working-directory: ./apps/${{ inputs.app }}
        run: pnpm turbo run e2e${{ inputs.update_snapshots && ':update' || '' }}

      # Upload screenshots + report
      - name: Upload Screenshots
        if: success() && inputs.update_snapshots
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ inputs.app }}
          path: './apps/${{ inputs.app }}/**/e2e/**/*.png'
          retention-days: 1
      - name: Publish Report
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report-${{ inputs.app }}
          path: './apps/${{ inputs.app }}/playwright-report'
          retention-days: 30
