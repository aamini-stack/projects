name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      update_snapshots:
        description: 'Whether to update the playwright reference screenshots'
        required: false
        type: boolean
        default: false

env:
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      apps: ${{ steps.get-apps.outputs.apps }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Setup Node
        uses: ./.github/actions/setup
      - name: Build
        run: pnpm turbo run build format typecheck lint test
      - name: Get Changed Apps
        id: get-apps
        run: |
          APPS=$(pnpm turbo ls --output=json --filter="./apps/*" | jq -c '[.packages.items[] | .name]')
          echo "apps=$APPS" >> $GITHUB_OUTPUT

  deploy:
    needs: [build]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app: ${{ fromJson(needs.build.outputs.apps) }}
    steps:
      # Setup
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Setup Node
        uses: ./.github/actions/setup
      # Deploy
      - name: Install Vercel CLI
        run: pnpm add --global vercel@latest
      - name: Link To Project
        working-directory: ./apps/${{ matrix.app }}
        run: vercel link --yes --repo --token=${{ secrets.VERCEL_TOKEN }} --scope=${{ vars.TURBO_TEAM }}
      - name: Deploy To Vercel
        working-directory: ./apps/${{ matrix.app }}
        run: vercel deploy --yes --token=${{ secrets.VERCEL_TOKEN }} --scope=${{ vars.TURBO_TEAM }} ${{ github.ref == 'refs/heads/main' && '--prod' || '' }}

  e2e:
    needs: [build, deploy]
    runs-on: windows-latest
    strategy:
      matrix:
        app: ${{ fromJson(needs.build.outputs.apps) }}
    steps:
      # Setup
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Setup Node
        uses: ./.github/actions/setup

      - name: Install Playwright Browsers
        working-directory: ./apps/${{ matrix.app }}
        run: pnpm exec playwright install --with-deps

      - name: Run Playwright tests
        working-directory: ./apps/${{ matrix.app }}
        env:
          BASE_URL: https://${{ matrix.app }}-git-${{ github.head_ref || github.ref_name }}-${{ vars.TURBO_TEAM }}.vercel.app
        run: pnpm turbo run e2e${{ inputs.update_snapshots && ':update' || '' }}

      - name: Update Screenshots
        if: ${{ !failure() && inputs.update_snapshots }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "*/*.png"
          git commit -m "Update Screenshots"
          git push

      - name: Publish Report
        uses: actions/upload-artifact@v4
        if: ${{ failure() }}
        with:
          name: playwright-report-${{ matrix.app }}
          path: '**/apps/${{ matrix.app }}/playwright-report'
          retention-days: 30

  ci-successs:
    needs: [build, deploy, e2e]
    runs-on: ubuntu-latest
    steps:
      - run: echo Done!
