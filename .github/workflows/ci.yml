name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      update_snapshots:
        description: 'Whether to update the playwright reference screenshots'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

env:
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}

jobs:
  quality-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Setup Node
        uses: ./.github/actions/setup
      - name: Build
        run: pnpm turbo run format typecheck lint test

  find-apps:
    runs-on: ubuntu-latest
    outputs:
      apps: ${{ steps.calculate-apps.outputs.apps }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Get Changed Apps
        id: calculate-apps
        working-directory: ./apps
        run: |
          echo "apps=$(ls -d * | jq -R | jq -s -c)" >> $GITHUB_OUTPUT

  test:
    needs: [find-apps]
    strategy:
      matrix:
        app: ${{ fromJson(needs.find-apps.outputs.apps) }}
      fail-fast: false
    uses: ./.github/workflows/e2e.yml
    with:
      app: ${{ matrix.app }}
    secrets: inherit

  ci-success:
    runs-on: ubuntu-latest
    needs: [quality-checks, test]
    steps:
      - name: Log Finished
        run: echo 'Run Successful'

  commit-screenshots:
    runs-on: ubuntu-latest
    needs: [quality-checks, test]
    if: inputs.update_snapshots
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Download All Screenshot Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: screenshots-*
          merge-multiple: true
      - name: Commit Screenshots
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git pull --ff-only
          git status
          git add .
          git commit -m "Update Screenshots"
          git push
