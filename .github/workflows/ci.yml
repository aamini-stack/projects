name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      update_snapshots:
        description: 'Whether to update the playwright reference screenshots'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

env:
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Setup Node
        uses: ./.github/actions/setup
      - name: Build
        run: pnpm turbo run format typecheck lint test

  find-apps:
    runs-on: ubuntu-latest
    outputs:
      apps: ${{ steps.calculate-apps.outputs.apps }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Get Changed Apps
        id: calculate-apps
        working-directory: ./apps
        run: |
          echo "apps=$(ls -d * | jq -R | jq -s -c)" >> $GITHUB_OUTPUT

  e2e:
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.54.2-noble
      options: --user 1001
    needs: [find-apps]
    strategy:
      matrix:
        app: ${{ fromJson(needs.find-apps.outputs.apps) }}
      fail-fast: false
    steps:
      # Setup
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Node
        uses: ./.github/actions/setup
      - name: Link To Project
        run: pnpm vercel link --yes --repo --token=${{ secrets.VERCEL_TOKEN }} --scope=${{ vars.TURBO_TEAM }}
      - name: Deploy To Vercel
        working-directory: ./apps/${{ matrix.app }}
        run: |
          BASE_URL=$(pnpm vercel \
            --yes \
            ${{ github.ref_name == 'main' && '--prod' || '' }} \
            --token=${{ secrets.VERCEL_TOKEN }} \
            --scope=${{ vars.TURBO_TEAM }} \
            -m githubDeployment='1' \
            -m githubCommitRef='${{ github.head_ref || github.ref_name }}' \
            -m githubCommitSha='${{ github.sha }}' \
            | tail -1)
          echo BASE_URL=$BASE_URL >> $GITHUB_ENV
      - name: Run Playwright tests
        working-directory: ./apps/${{ matrix.app }}
        run: pnpm turbo run e2e${{ inputs.update_snapshots && ':update' || '' }}
      - name: Upload Screenshots
        if: inputs.update_snapshots
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ matrix.app }}
          path: './*/**/e2e/**/*.png'
          retention-days: 1
      # Report
      - name: Publish Report
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report-${{ matrix.app }}
          path: './apps/${{ matrix.app }}/playwright-report'
          retention-days: 30

  commit-screenshots:
    runs-on: ubuntu-latest
    needs: [e2e]
    if: success() && inputs.update_snapshots
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Download All Screenshot Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: screenshots-*
          merge-multiple: true
      - name: Commit Screenshots
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git pull --ff-only
          git add *.png
          git commit -m "Update Screenshots"
          git push
